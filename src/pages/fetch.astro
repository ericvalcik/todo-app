---
import { app } from "../firebase/server";
import { getAuth } from "firebase-admin/auth";
import Layout from "../layouts/Layout.astro";

const auth = getAuth(app);

/* Check current session */
if (!Astro.cookies.has("session")) {
  return Astro.redirect("/signin");
}
const sessionCookie = Astro.cookies.get("session").value;
const decodedCookie = await auth.verifySessionCookie(sessionCookie);
const user = await auth.getUser(decodedCookie.uid);

if (!user) {
  return Astro.redirect("/signin");
}

import { InsertUser, users } from "../db/schema";
import { drizzle } from "drizzle-orm/libsql";
import { createClient } from "@libsql/client";
import Layout from "../layouts/Layout.astro";

const client = createClient({
  url: import.meta.env.DATABASE_URL,
  authToken: import.meta.env.DATABASE_AUTH_TOKEN,
});
const db = drizzle(client);
const insertUser = async (user: InsertUser) => {
  return await db.insert(users).values(user).execute();
};

// await insertUser({ fullName: "Pavel Flekac", phone: "123456789" })
---

<Layout title="Add new user" page="fetch">
  <h1>Add a new user</h1>
  <form hx-post="/add-user" class="flex flex-col max-w-md py-6">
    <label for="fullName">Full name</label>
    <input type="text" id="fullName" name="fullName" />
    <label for="phone">Phone</label>
    <input type="text" id="phone" name="phone" />
    <button
      type="submit"
      class="rounded-md bg-black text-white px-3 py-0.5 w-fit mt-3"
      >Add
    </button>
  </form>
</Layout>
